<?php
session_start();
require_once '../includes/config.php';
require_once '../includes/functions.php';

// Check if user is logged in and is a bus owner
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'bus_owner') {
    header('Location: ../login.php');
    exit();
}

$success = false;
$error = '';
$user_id = $_SESSION['user_id'];
$company_name = '';

// Get owner's company name if exists
$stmt = $pdo->prepare("SELECT company_name FROM bus_owners WHERE user_id = ?");
$stmt->execute([$user_id]);
$owner_data = $stmt->fetch();

if ($owner_data && !empty($owner_data['company_name'])) {
    $company_name = $owner_data['company_name'];
}

// Process form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $registration_number = trim($_POST['registration_number'] ?? '');
    $bus_name = trim($_POST['bus_name'] ?? '');
    $route_number = trim($_POST['route_number'] ?? '');
    $route_description = trim($_POST['route_description'] ?? '');
    $company_name = trim($_POST['company_name'] ?? '');
    
    // Basic validation
    if (empty($registration_number) || empty($company_name)) {
        $error = 'Registration number and company name are required.';
    } elseif (!validate_registration_number($registration_number)) {
        $error = 'Please enter a valid registration number (e.g., NA-1234 or 62-1234).';
    } else {
        // Format registration number
        $registration_number = format_registration_number($registration_number);
        // Make bus name NULL if empty
        $bus_name = !empty($bus_name) ? $bus_name : NULL;
        try {
            $pdo->beginTransaction();
            
            // Update or insert company name
            if ($owner_data) {
                $stmt = $pdo->prepare("UPDATE bus_owners SET company_name = ? WHERE user_id = ?");
                $stmt->execute([$company_name, $user_id]);
            } else {
                $stmt = $pdo->prepare("INSERT INTO bus_owners (user_id, company_name) VALUES (?, ?)");
                $stmt->execute([$user_id, $company_name]);
            }
            
            // Add the bus
            $stmt = $pdo->prepare("
                INSERT INTO buses 
                (registration_number, bus_name, route_number, route_description, company_name, user_id, created_at) 
                VALUES (?, ?, ?, ?, ?, ?, NOW())
            
            $pdo->commit();
            $success = true;
            
        } catch (PDOException $e) {
            $pdo->rollBack();
            $error = 'An error occurred. Please try again.';
            error_log("Add Bus Error: " . $e->getMessage());
        }
    }
}

$page_title = 'Add New Bus - ' . SITE_NAME;
?>

<?php include '../includes/header.php'; ?>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0">
                        <i class="fas fa-bus me-2"></i> Add New Bus
                    </h2>
                </div>
                <div class="card-body">
                    <?php if ($success): ?>
                        <div class="alert alert-success">
                            <h4><i class="fas fa-check-circle"></i> Bus Added Successfully!</h4>
                            <p class="mb-0">Your bus has been added to the system.</p>
                            <div class="mt-3">
                                <a href="add-bus.php" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-plus-circle me-1"></i> Add Another Bus
                                </a>
                                <a href="dashboard.php" class="btn btn-primary">
                                    <i class="fas fa-tachometer-alt me-1"></i> Go to Dashboard
                                </a>
                            </div>
                        </div>
                    <?php else: ?>
                        <?php if ($error): ?>
                            <div class="alert alert-danger"><?php echo htmlspecialchars($error); ?></div>
                        <?php endif; ?>
                        
                        <form method="post" action="add-bus.php" class="needs-validation" novalidate>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="company_name" class="form-label">Company Name *</label>
                                    <input type="text" class="form-control" id="company_name" 
                                           name="company_name" required value="<?php echo htmlspecialchars($company_name); ?>">
                                    <div class="invalid-feedback">Please enter your company name.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bus_name" class="form-label">Bus Name <small class="text-muted">(Optional)</small></label>
                                    <input type="text" class="form-control" id="bus_name" name="bus_name" 
                                           value="<?php echo htmlspecialchars($_POST['bus_name'] ?? ''); ?>"
                                           placeholder="e.g., Nelum Kumari">
                                    <div class="form-text">Leave blank if you don't have a specific name for this bus.</div>
                                </div>
                                
                                <div class="col-12">
                                    <label for="registration_number" class="form-label">Registration Number *</label>
                                    <input type="text" class="form-control" id="registration_number" 
                                           name="registration_number" required 
                                           pattern="([A-Za-z]{2}-?\d{4}|\d{2}-?\d{4})"
                                           placeholder="e.g., NA-1234 or 62-1234"
                                           oninput="formatRegistrationNumber(this)">
                                    <div class="invalid-feedback">Please enter a valid registration number (e.g., NA-1234 or 62-1234).</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="route_number" class="form-label">Route Number <small class="text-muted">(Optional)</small></label>
                                    <input type="text" class="form-control" id="route_number" 
                                           name="route_number"
                                           placeholder="1">
                                    <div class="form-text">Leave blank if not applicable.</div>
                                </div>
                                
                                <div class="col-12">
                                    <label for="route_description" class="form-label">Route Description</label>
                                    <textarea class="form-control" id="route_description" 
                                              name="route_description" rows="3" 
                                              placeholder="e.g., From City A to City B via Highway 1"></textarea>
                                </div>
                                
                                <div class="col-12 mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i> Save Bus Details
                                    </button>
                                    <a href="dashboard.php" class="btn btn-outline-secondary ms-2">
                                        <i class="fas fa-times me-1"></i> Cancel
                                    </a>
                                </div>
                            </div>
                        </form>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Format registration number as user types
function formatRegistrationNumber(input) {
    // Remove any non-alphanumeric characters
    let value = input.value.replace(/[^a-zA-Z0-9]/g, '');
    
    // If we have 6 characters, insert a dash after the first 2
    if (value.length > 2 && value.length <= 6) {
        value = value.substring(0, 2) + '-' + value.substring(2);
    }
    
    // Update the input value
    input.value = value.toUpperCase();
}

// Form validation
(function () {
    'use strict'
    
    // Make bus name not required
    document.addEventListener('DOMContentLoaded', function() {
        const busNameField = document.getElementById('bus_name');
        if (busNameField) {
            busNameField.required = false;
        }
        
        // Format registration number on page load if it exists
        const regNumberField = document.getElementById('registration_number');
        if (regNumberField && regNumberField.value) {
            formatRegistrationNumber(regNumberField);
        }
    });

    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.querySelectorAll('.needs-validation');

    // Loop over them and prevent submission
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            form.classList.add('was-validated');
        }, false);
    });
})();
</script>

<?php include '../includes/footer.php'; ?>
